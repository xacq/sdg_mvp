{% extends "ui/base.html" %}
{% block title %}Alertas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Alertas</h3>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Estado</label>
        <select name="status" class="form-select">
          <option value="OPEN" {% if status == "OPEN" %}selected{% endif %}>OPEN</option>
          <option value="ACK" {% if status == "ACK" %}selected{% endif %}>ACK</option>
          <option value="CLOSED" {% if status == "CLOSED" %}selected{% endif %}>CLOSED</option>
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Severidad</label>
        <select name="severity" class="form-select">
          <option value="" {% if severity == "" %}selected{% endif %}>Todas</option>
          <option value="5" {% if severity == "5" %}selected{% endif %}>5</option>
          <option value="4" {% if severity == "4" %}selected{% endif %}>4</option>
          <option value="3" {% if severity == "3" %}selected{% endif %}>3</option>
          <option value="2" {% if severity == "2" %}selected{% endif %}>2</option>
          <option value="1" {% if severity == "1" %}selected{% endif %}>1</option>
        </select>
      </div>

      <div class="col-md-5">
        <label class="form-label">Buscar</label>
        <input class="form-control" type="text" name="q" value="{{ q }}" placeholder="Nombre del documento o ID">
      </div>

      <div class="col-md-2">
        <button class="btn btn-primary w-100" type="submit">Filtrar</button>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Documento</th>
          <th>Sev</th>
          <th>Estado</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
      {% for a in alerts %}
        <tr>
          <td>{{ a.id }}</td>
          <td>
            <a href="{% url 'document_detail' a.document.id %}">
              #{{ a.document.id }} - {{ a.document.original_name }}
            </a>
          </td>
          <td>
            {% if a.severity >= 4 %}
              <span class="badge text-bg-danger">{{ a.severity }}</span>
            {% else %}
              <span class="badge text-bg-warning">{{ a.severity }}</span>
            {% endif %}
          </td>
          <td>
            {% if a.status == "OPEN" %}
              <span class="badge text-bg-danger">OPEN</span>
            {% elif a.status == "ACK" %}
              <span class="badge text-bg-success">ACK</span>
            {% else %}
              <span class="badge text-bg-secondary">CLOSED</span>
            {% endif %}
          </td>
          <td>{{ a.created_at|date:"Y-m-d H:i" }}</td>
          <td>            
            {% if a.status == "OPEN" %}
                {% if perms.alerts.ack_alert %}
                <form class="d-inline" method="post" action="{% url 'alert_ack' a.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-danger">Atender (ACK)</button>
                </form>
                {% endif %}
                {% if perms.alerts.change_alert %}
                <form class="d-inline" method="post" action="{% url 'alert_close' a.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary">Cerrar</button>
                </form>
                {% endif %}
            {% elif a.status == "ACK" %}
                {% if perms.alerts.change_alert %}
                <form class="d-inline" method="post" action="{% url 'alert_close' a.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-secondary">Cerrar</button>
                </form>
                <form class="d-inline" method="post" action="{% url 'alert_reopen' a.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-primary">Reabrir</button>
                </form>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
            {% else %}
                {% if perms.alerts.change_alert %}
                <form method="post" action="{% url 'alert_reopen' a.id %}">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-outline-primary">Reabrir</button>
                </form>
                {% else %}
                <span class="text-muted">—</span>
                {% endif %}
            {% endif %}
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No hay alertas para los filtros seleccionados.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
