{% extends "ui/base.html" %}
{% block title %}Auditoría{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3>Auditoría</h3>
</div>

<div class="card shadow-sm mb-3">
  <div class="card-body">
    <form method="get" class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">Tipo de evento</label>
        <select name="event_type" class="form-select">
          <option value="" {% if event_type == "" %}selected{% endif %}>Todos</option>
          {% for t in event_types %}
            <option value="{{ t }}" {% if event_type == t %}selected{% endif %}>{{ t }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Usuario</label>
        <input class="form-control" type="text" name="actor" value="{{ actor }}" placeholder="username">
      </div>

      <div class="col-md-2">
        <label class="form-label">Desde</label>
        <input class="form-control" type="date" name="from" value="{{ date_from }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Hasta</label>
        <input class="form-control" type="date" name="to" value="{{ date_to }}">
      </div>

      <div class="col-md-2">
        <label class="form-label">Buscar</label>
        <input class="form-control" type="text" name="q" value="{{ q }}" placeholder="object_id, mensaje...">
      </div>

      <div class="col-md-1">
        <button class="btn btn-primary w-100" type="submit">Filtrar</button>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-body">
    <table class="table table-hover align-middle">
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Evento</th>
          <th>Actor</th>
          <th>Objeto</th>
          <th>Mensaje</th>
        </tr>
      </thead>
      <tbody>
      {% for e in events %}
        <tr>
          <td>{{ e.created_at|date:"Y-m-d H:i" }}</td>
          <td><span class="badge text-bg-dark">{{ e.event_type }}</span></td>
          <td>{% if e.actor %}{{ e.actor.username }}{% else %}—{% endif %}</td>
          <td>
            <code>{{ e.object_type }}</code>
            <span class="text-muted">#{{ e.object_id }}</span>

            {% if e.object_type == "Document" %}
              <div>
                <a href="{% url 'document_detail' e.object_id %}">Ver documento</a>
              </div>
            {% endif %}
          </td>
          <td>{{ e.message|default:"—" }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="5">No hay eventos para los filtros seleccionados.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
